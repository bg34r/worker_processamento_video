name: ci-cd

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  
jobs:
  test-coverage:
    runs-on: ubuntu-latest
    outputs:
      coverage-passed: ${{ steps.coverage-check.outputs.passed }}
      coverage-percentage: ${{ steps.coverage-check.outputs.coverage }}
    
    steps:
      - name: Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Instalar dependÃªncias
        run: go mod download

      - name: Executar testes com cobertura
        run: |
          echo "ğŸ” Executando todos os testes com cobertura..."
          go test ./internal/infrastructure/... -coverprofile=coverage -covermode=count -v
          echo "ğŸ“Š Gerando relatÃ³rio..."
          go tool cover -func=coverage | tee coverage_report.txt
          echo "ğŸ“‹ RelatÃ³rio gerado:"
          cat coverage_report.txt

      - name: Verificar limite de cobertura
        id: coverage-check
        run: |
          echo "ğŸ“Š Analisando cobertura de testes..."
          
          if [ ! -f coverage ]; then
            echo "âŒ Arquivo coverage nÃ£o foi encontrado!"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "coverage=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          COVERAGE=$(go tool cover -func=coverage | grep total | awk '{print $3}' | sed 's/%//')
          
          if [ -z "$COVERAGE" ]; then
            echo "âŒ NÃ£o foi possÃ­vel extrair a porcentagem de cobertura!"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "coverage=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ğŸ¯ RESULTADO DA COBERTURA:"
          echo "   â€¢ Cobertura atual: ${COVERAGE}%"
          echo "   â€¢ Limite mÃ­nimo: 60%"
          
          # Sempre definir o output de coverage
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          
          if awk "BEGIN {exit !($COVERAGE >= 60)}"; then
            echo ""
            echo "âœ… SUCESSO: Cobertura de ${COVERAGE}% atende o limite mÃ­nimo de 60%"
            echo "ğŸš€ Pull Request pode prosseguir!"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ FALHA: Cobertura de ${COVERAGE}% estÃ¡ abaixo do limite mÃ­nimo de 60%"
            echo "ğŸ“ˆ Adicione mais testes para atingir o requisito"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: AnÃ¡lise SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload dos relatÃ³rios de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorio-cobertura
          path: |
            coverage
            coverage_report.txt

  build:
    needs: test-coverage
    if: needs.test-coverage.outputs.coverage-passed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Compilar aplicaÃ§Ã£o
        run: go build -v -o main ./cmd/server/main.go
  
      - name: Upload do artefato de build
        uses: actions/upload-artifact@v4
        with:
          name: programa
          path: main 

  docker:
    needs: [test-coverage, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: Build Docker image
        run: |
          echo "ğŸ³ Construindo imagem Docker..."
          docker build -t video-worker:ci .
          echo "âœ… Imagem construÃ­da com sucesso!"

  coverage-gate:
    needs: test-coverage
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Controle de Cobertura
        run: |
          echo "ğŸ¯ GATE DE COBERTURA - Resultado Final"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # VerificaÃ§Ã£o mais robusta
          COVERAGE_PASSED="${{ needs.test-coverage.outputs.coverage-passed }}"
          COVERAGE_PERCENTAGE="${{ needs.test-coverage.outputs.coverage-percentage }}"
          
          if [ "$COVERAGE_PASSED" != "true" ]; then
            echo "âŒ STATUS: REJEITADO"
            echo "ğŸ“Š Cobertura: ${COVERAGE_PERCENTAGE}% (abaixo de 60%)"
            echo "ğŸš« Pull Request bloqueado por cobertura insuficiente"
            echo ""
            echo "ğŸ“‹ PRÃ“XIMOS PASSOS:"
            echo "   1. Adicione mais testes unitÃ¡rios"
            echo "   2. Execute 'go test -cover ./internal/infrastructure/...' localmente"
            echo "   3. Foque nos arquivos com menor cobertura"
            echo "   4. FaÃ§a novo commit quando atingir 60%+"
            exit 1
          else
            echo "âœ… STATUS: APROVADO"
            echo "ğŸ“Š Cobertura: ${COVERAGE_PERCENTAGE}% (acima de 60%)"
            echo "ğŸ‰ Requisitos de cobertura atendidos"
            echo "ğŸš€ PR liberado para merge na branch main!"
          fi
